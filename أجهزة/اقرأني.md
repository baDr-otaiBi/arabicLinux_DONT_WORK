# مجلد واجهات الأجهزة والعتاد

<div dir="rtl">

## الوصف المعماري الشامل

يمثل مجلد `/أجهزة` التجسيد البرمجي للفلسفة الأساسية في أنظمة يونكس ولينكس: "كل شيء ملف" (Everything is a File). هذا المجلد يقابل المجلد `/dev` (اختصاراً لـ "devices") في توزيعات لينكس التقليدية، ويعد بمثابة طبقة التجريد (Abstraction Layer) بين العتاد المادي (Hardware) والبرمجيات (Software).

## الأسس الفلسفية والمعمارية

### ١. نموذج "كل شيء ملف" (Everything is a File Paradigm)

في أنظمة يونكس ولينكس، يتم التعامل مع الأجهزة كملفات عادية، مما يوحد واجهة البرمجة:

```c
// نفس واجهة البرمجة للملفات والأجهزة
int fd = open("/أجهزة/disk", O_RDWR);   // فتح قرص
write(fd, data, size);                  // كتابة بيانات
read(fd, buffer, size);                 // قراءة بيانات
close(fd);                              // إغلاق
```

#### الفوائد التقنية:
- **واجهة موحدة (Uniform Interface)**: نفس استدعاءات النظام للملفات والأجهزة
- **التجريد (Abstraction)**: إخفاء تعقيدات العتاد
- **قابلية الإعادة التوجيه (Redirection)**: استخدام أنابيب وإعادة توجيه الإدخال/الإخراج
- **الأمان (Security)**: تطبيق نفس نظام الصلاحيات

### ٢. أنواع الأجهزة (Device Types)

#### أجهزة الكتل (Block Devices)
```
الخصائص:
- التعامل مع البيانات على شكل كتل (Blocks)
- دعم الوصول العشوائي (Random Access)
- التخزين المؤقت (Buffering/Caching)
- حجم كتلة ثابت (عادة 512 أو 4096 بايت)

الأمثلة:
- الأقراص الصلبة (HDD): /أجهزة/sda، /أجهزة/sdb
- أقراص الحالة الصلبة (SSD): /أجهزة/nvme0n1
- الأقراص الافتراضية (Loop Devices): /أجهزة/loop0
- أقراص RAID: /أجهزة/md0

البنية:
brw-rw---- 1 root disk 8, 0  /أجهزة/sda
│││         │    │    │  │
││└─ صلاحيات الآخرين
│└── صلاحيات المجموعة  
└─── b = Block Device
                     └─ Major:Minor Number
```

#### أجهزة الحروف (Character Devices)
```
الخصائص:
- التعامل مع البيانات حرفاً بحرف (Byte-by-byte)
- الوصول التسلسلي فقط (Sequential Access)
- بدون تخزين مؤقت (Unbuffered)
- تدفق مستمر للبيانات (Data Stream)

الأمثلة:
- الطرفيات (Terminals): /أجهزة/tty0، /أجهزة/pts/0
- المنافذ التسلسلية (Serial Ports): /أجهزة/ttyS0
- الطابعات (Printers): /أجهزة/lp0
- الأجهزة العشوائية (Random Devices): /أجهزة/random، /أجهزة/urandom

البنية:
crw-rw-rw- 1 root tty 4, 0  /أجهزة/tty0
│
└─ c = Character Device
```

## البنية الداخلية التفصيلية

```
/أجهزة
├── معلومات/                        # معلومات الأجهزة المكتشفة
│   ├── cpu/                        # معلومات المعالج
│   │   ├── المعلومات.txt          # CPU Info (model, cores, frequency)
│   │   ├── الذاكرة_المخبئية.txt   # Cache Information (L1, L2, L3)
│   │   └── الميزات.txt            # CPU Features (SSE, AVX, AES-NI)
│   │
│   ├── ذاكرة/                      # معلومات الذاكرة
│   │   ├── إجمالي_RAM.txt         # Total RAM
│   │   ├── المستخدمة.txt          # Used Memory
│   │   └── المتاحة.txt            # Available Memory
│   │
│   ├── تخزين/                      # أجهزة التخزين
│   │   ├── أقراص/
│   │   │   ├── sda.txt            # معلومات القرص الأول
│   │   │   │   # النموذج، السعة، الواجهة (SATA/NVMe)
│   │   │   │   # S.M.A.R.T. Status
│   │   │   └── nvme0n1.txt        # معلومات NVMe SSD
│   │   │
│   │   └── أقسام/
│   │       ├── sda1.txt           # القسم الأول
│   │       └── sda2.txt           # القسم الثاني
│   │
│   ├── شبكة/                       # أجهزة الشبكة
│   │   ├── eth0.txt               # Ethernet Interface
│   │   │   # MAC Address, Link Status, Speed (1G/10G)
│   │   ├── wlan0.txt              # WiFi Interface
│   │   │   # SSID, Signal Strength, Channel
│   │   └── lo.txt                 # Loopback Interface
│   │
│   ├── رسوميات/                   # بطاقات الرسوميات (GPU)
│   │   ├── المعلومات.txt          # GPU Model, VRAM, Driver
│   │   └── العرض.txt              # Display Resolution, Refresh Rate
│   │
│   ├── صوت/                        # بطاقات الصوت
│   │   ├── بطاقات.txt             # Sound Cards List
│   │   └── الأجهزة.txt            # Audio Devices (Playback/Capture)
│   │
│   └── USB/                        # أجهزة USB
│       ├── قائمة.txt              # lsusb Output
│       └── الأجهزة_المتصلة/
│           ├── لوحة_مفاتيح.txt
│           ├── فأرة.txt
│           └── طابعة.txt
│
├── كتل/                            # أجهزة الكتل (Block Devices)
│   ├── sda → /sys/block/sda       # رابط رمزي إلى sysfs
│   ├── sda1 → القسم الأول
│   ├── sda2 → القسم الثاني
│   ├── nvme0n1 → NVMe SSD
│   ├── loop0 → جهاز حلقي
│   └── md0 → RAID Array
│
├── حروف/                          # أجهزة الحروف (Character Devices)
│   ├── tty0 → الطرفية الرئيسية
│   ├── pts/ → الطرفيات الوهمية (Pseudo-terminals)
│   ├── random → مولد أرقام عشوائية حقيقية
│   ├── urandom → مولد أرقام عشوائية شبه حقيقية
│   ├── null → الجهاز الفارغ (/dev/null)
│   └── zero → مولد الأصفار
│
├── شبكة/                           # أجهزة الشبكة
│   ├── eth0 → Ethernet
│   ├── wlan0 → WiFi
│   ├── lo → Loopback
│   └── tun0 → VPN Tunnel
│
└── خاصة/                          # أجهزة خاصة (Special Devices)
    ├── console → وحدة التحكم الرئيسية
    ├── kmsg → رسائل النواة
    ├── fb0 → Framebuffer (الذاكرة الإطارية)
    └── input/ → أجهزة الإدخال
        ├── event0 → لوحة المفاتيح
        ├── event1 → الفأرة
        └── event2 → شاشة اللمس
```

## المفاهيم التقنية المتقدمة

### الأرقام الرئيسية والثانوية (Major and Minor Numbers)

كل جهاز يُعرّف برقمين:

#### الرقم الرئيسي (Major Number)
- **يحدد برنامج التشغيل (Driver)** المسؤول عن الجهاز
- مثال: جميع أقراص SCSI/SATA لها Major = 8

#### الرقم الثانوي (Minor Number)
- **يحدد الجهاز المحدد** ضمن مجموعة أجهزة نفس النوع
- مثال: sda = Minor 0، sda1 = Minor 1، sda2 = Minor 2

```bash
$ ls -l /dev/sda*
brw-rw---- 1 root disk 8, 0   /dev/sda     # القرص الكامل
brw-rw---- 1 root disk 8, 1   /dev/sda1    # القسم الأول
brw-rw---- 1 root disk 8, 2   /dev/sda2    # القسم الثاني
                       │  │
                       │  └── Minor Number
                       └───── Major Number
```

### udev - مدير الأجهزة الديناميكي (Dynamic Device Manager)

#### آلية العمل:

```
1. النواة تكتشف جهازاً جديداً
   ↓
2. النواة ترسل حدثاً (uevent) إلى udev عبر netlink socket
   ↓
3. udev يقرأ قواعده من /etc/udev/rules.d/
   ↓
4. تطبيق القواعد (Matching Rules)
   ↓
5. إنشاء ملف الجهاز في /dev/
   ↓
6. تعيين الصلاحيات والمالك
   ↓
7. إنشاء روابط رمزية إضافية
   ↓
8. تنفيذ إجراءات إضافية (تحميل firmware، تشغيل سكربتات)
```

#### مثال على قاعدة udev:
```bash
# /etc/udev/rules.d/99-custom.rules

# تعيين اسم ثابت لبطاقة الشبكة حسب MAC Address
SUBSYSTEM=="net", ATTR{address}=="00:11:22:33:44:55", NAME="شبكة_رئيسية"

# تغيير الصلاحيات لجهاز معين
KERNEL=="ttyUSB0", MODE="0666", GROUP="مستخدمون"

# تنفيذ سكربت عند توصيل USB معين
SUBSYSTEM=="usb", ATTR{idVendor}=="1234", ATTR{idProduct}=="5678", \
  RUN+="/usr/local/bin/سكربت_USB.sh"
```

### sysfs - نظام الملفات الافتراضي (/sys)

واجهة للتفاعل مع النواة والأجهزة:

```
/sys
├── block/                      # أجهزة الكتل
│   └── sda/
│       ├── size               # حجم القرص بالقطاعات
│       ├── removable          # قابل للإزالة؟ (0/1)
│       ├── queue/             # إعدادات طابور الإدخال/الإخراج
│       │   ├── scheduler      # خوارزمية الجدولة (noop, deadline, cfq)
│       │   ├── nr_requests    # حجم الطابور
│       │   └── read_ahead_kb  # القراءة المسبقة
│       └── device/
│           └── model          # نموذج القرص
│
├── class/                      # تصنيف الأجهزة حسب النوع
│   ├── net/                   # أجهزة الشبكة
│   │   └── eth0/
│   │       ├── address        # MAC Address
│   │       ├── mtu            # Maximum Transmission Unit
│   │       ├── speed          # السرعة (Mbps)
│   │       └── statistics/    # إحصائيات (packets, bytes, errors)
│   │
│   └── thermal/               # الحرارة
│       └── thermal_zone0/
│           ├── temp           # الحرارة الحالية (millidegrees)
│           └── type           # نوع المستشعر
│
└── devices/                    # الشجرة الهرمية للأجهزة
    └── pci0000:00/            # ناقل PCI
        ├── 0000:00:00.0/      # جسر المضيف (Host Bridge)
        ├── 0000:00:02.0/      # بطاقة الرسوميات
        └── 0000:00:1f.2/      # متحكم SATA
```

### procfs - نظام الملفات الافتراضي (/proc)

معلومات عن العمليات والنظام:

```
/proc
├── cpuinfo                    # معلومات المعالج
├── meminfo                    # معلومات الذاكرة
├── loadavg                    # متوسط الحمل (Load Average)
├── uptime                     # وقت التشغيل
├── version                    # إصدار النواة
├── cmdline                    # معاملات إقلاع النواة
├── modules                    # وحدات النواة المحملة
├── filesystems                # أنظمة الملفات المدعومة
├── partitions                 # الأقسام
├── mounts                     # الأنظمة الملفات المحملة
│
├── net/                       # معلومات الشبكة
│   ├── dev                    # إحصائيات واجهات الشبكة
│   ├── route                  # جدول التوجيه
│   ├── arp                    # جدول ARP
│   └── tcp                    # اتصالات TCP
│
└── [PID]/                     # معلومات عملية محددة
    ├── cmdline                # سطر الأوامر
    ├── environ                # متغيرات البيئة
    ├── status                 # الحالة (PID, Memory, State)
    ├── fd/                    # واصفات الملفات المفتوحة
    ├── maps                   # خريطة الذاكرة
    └── stat                   # إحصائيات (CPU, Memory usage)
```

## تقنيات الإدخال/الإخراج المتقدمة

### DMA (Direct Memory Access)
- **المبدأ**: نقل البيانات مباشرة بين الجهاز والذاكرة دون تدخل CPU
- **الفائدة**: تحرير CPU للقيام بمهام أخرى
- **التطبيق**: أقراص التخزين، بطاقات الشبكة

### MMIO (Memory-Mapped I/O)
```c
// تعيين عناوين ذاكرة للوصول إلى سجلات الجهاز
volatile uint32_t *device_register = (uint32_t *)0xFEDC0000;
*device_register = 0x12345678;  // الكتابة إلى الجهاز
uint32_t value = *device_register;  // القراءة من الجهاز
```

### Interrupts (المقاطعات)
```
دورة حياة المقاطعة:
1. الجهاز ينهي عملية (مثل: اكتمال نقل البيانات)
   ↓
2. الجهاز يرسل إشارة مقاطعة (IRQ) إلى CPU
   ↓
3. CPU يوقف العملية الحالية مؤقتاً
   ↓
4. CPU يحفظ السياق (Context Saving)
   ↓
5. CPU ينفذ معالج المقاطعة (Interrupt Handler)
   ↓
6. معالج المقاطعة يتعامل مع الحدث
   ↓
7. CPU يستعيد السياق ويكمل العملية المقاطعة
```

### خوارزميات جدولة الإدخال/الإخراج (I/O Schedulers)

#### NOOP (No Operation)
- **البساطة**: طابور FIFO بسيط
- **الاستخدام**: أقراص SSD، NVMe (التي لديها جدولة داخلية)

#### Deadline
- **ضمان زمن الاستجابة**: كل طلب له موعد نهائي
- **الفائدة**: منع التجويع (Starvation)
- **الاستخدام**: قواعد البيانات، الخوادم

#### CFQ (Completely Fair Queuing)
- **العدالة**: توزيع عادل للموارد بين العمليات
- **الأولويات**: دعم أولويات I/O المختلفة
- **الاستخدام**: أنظمة سطح المكتب

#### BFQ (Budget Fair Queuing)
- **التحسين**: أداء أفضل في البيئات التفاعلية
- **الميزات**: كمون منخفض، استجابة سريعة

#### mq-deadline / Kyber
- **متعدد الطوابير (Multi-Queue)**: استغلال الأجهزة الحديثة متعددة النوى
- **الأداء**: تحسين كبير في NVMe SSDs

## الأمان وإدارة الوصول

### الصلاحيات التقليدية (Traditional Permissions)
```bash
crw-rw---- 1 root disk 8, 0  /dev/sda
│││ ││ │
││└ Other
│└─ Group (disk): rw-
└── Owner (root): rw-
```

### قوائم التحكم بالوصول (ACLs)
```bash
# منح مستخدم صلاحيات إضافية
setfacl -m u:أحمد:rw /dev/sda1

# منح مجموعة صلاحيات
setfacl -m g:مطورون:r /dev/ttyUSB0
```

### SELinux Contexts
```bash
# عرض سياق الأمان
ls -Z /dev/sda
# النتيجة: system_u:object_r:fixed_disk_device_t:s0
```

## التطبيقات المستقبلية

### Hotplug والتوصيل الحار (Hot-Plugging)
- **الدعم الكامل**: توصيل وإزالة الأجهزة دون إيقاف النظام
- **الكشف التلقائي**: udev يتعرف على الأجهزة الجديدة فوراً

### GPU Computing
- **CUDA/ROCm**: استخدام GPU للحسابات العامة (GPGPU)
- **الوصول**: عبر `/dev/nvidia0` أو `/dev/dri/renderD128`

### IoT وإنترنت الأشياء
- **دعم أجهزة متنوعة**: مستشعرات، محركات، كاميرات
- **البروتوكولات**: I2C, SPI, GPIO عبر /dev/

</div>
